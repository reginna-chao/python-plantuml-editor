<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure PlantUML Editor</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Secure PlantUML Editor</h1>
            <p>Supports both local backend and cloud service modes</p>
        </div>
        
        <div class="mode-selector">
            <div class="mode-tabs">
                <button data-mode="cloud" class="mode-tab" onclick="switchMode('cloud')">Cloud Mode (Fast)</button>
                <button data-mode="local" class="mode-tab" onclick="switchMode('local')">Local Mode (Secure)</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="editor-panel">
                <div class="panel-title">PlantUML Syntax Editor</div>
                
                <!-- Cloud Mode -->
                <div id="cloud-mode" class="mode-content" data-mode="cloud">
                    <div class="warning">
                        <h4>‚ö†Ô∏è Security Warning</h4>
                        <p>Cloud mode sends your PlantUML code to an external server for processing. Do not use this mode for confidential or sensitive information.</p>
                    </div>
                </div>
                
                <!-- Local Mode -->
                <div id="local-mode" class="mode-content" data-mode="local">
                    <div class="security-info">
                        <h4>üîí Secure Mode</h4>
                        <p>Local mode sends code to your own backend server, ensuring no data leakage. Requires a local backend service setup.</p>
                    </div>
                    
                    <div class="server-config">
                        <label for="serverUrl">Backend Server URL:</label>
                        <input type="text" id="serverUrl" value="http://localhost:5000/render" 
                               placeholder="http://localhost:5000/render">
                    </div>
                </div>
                
                <textarea id="plantUmlInput" placeholder="Enter your PlantUML code here...">@startuml
!theme plain
title System Login Flow

actor User as User
participant "Web Application" as Web
participant "Authentication Service" as Auth
participant "Database" as DB

User -> Web: Enter username & password
Web -> Auth: Send authentication request
Auth -> DB: Query user data
DB --> Auth: Return user data

alt Authentication success
    Auth --> Web: Return Token
    Web --> User: Login success
else Authentication failed
    Auth --> Web: Error message
    Web --> User: Login failed
end

@enduml</textarea>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="generateDiagram()">
                        Generate Diagram
                    </button>
                    <button class="btn btn-secondary" onclick="clearInput()">
                        Clear Input
                    </button>
                    <button class="btn btn-secondary" onclick="downloadDiagram()">
                        Download Image
                    </button>
                    
                    <div class="format-selector">
                        <label>
                            <input type="radio" name="format" value="svg" checked>
                            SVG
                        </label>
                        <label>
                            <input type="radio" name="format" value="png">
                            PNG
                        </label>
                    </div>
                </div>
                
                <div class="examples">
                    <h3>Example Code</h3>
                    <button class="example-btn" onclick="loadExample('sequence')">Sequence Diagram Example</button>
                    <button class="example-btn" onclick="loadExample('class')">Class Diagram Example</button>
                    <button class="example-btn" onclick="loadExample('usecase')">Use Case Diagram Example</button>
                    <button class="example-btn" onclick="loadExample('activity')">Activity Diagram Example</button>
                </div>
            </div>
            
            <div class="preview-panel">
                <div class="panel-title">Diagram Preview</div>
                
                <div class="preview-container" id="previewContainer">
                    <div class="loading" id="loading">Generating diagram...</div>
                    <img id="diagramPreview" style="display: none;" alt="PlantUML Diagram Preview">
                    <div id="errorMessage" style="display: none;" class="error"></div>
                    <div class="placeholder-text" id="placeholderText">
                        <p>Click the "Generate Diagram" button to render your UML diagram</p>
                        <p>Please choose a mode: Cloud Mode is fast and convenient, Local Mode protects your privacy</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PlantUML Encoder for Cloud Mode -->
    <script src="https://cdn.jsdelivr.net/npm/plantuml-encoder@1.4.0/dist/plantuml-encoder.min.js"></script>

    <script>
        let currentMode = 'local';
        let currentImageBlob = null;

        switchMode(currentMode)

        const examples = {
            sequence: `@startuml
!theme plain
title Order Processing Flow

actor Customer as Customer
participant "E-commerce Website" as Web
participant "Order System" as Order
participant "Inventory System" as Inventory
participant "Payment System" as Payment

Customer -> Web: Place order
Web -> Order: Create order
Order -> Inventory: Check stock

alt Stock available
    Inventory --> Order: Stock confirmed
    Order -> Payment: Process payment
    
    alt Payment successful
        Payment --> Order: Payment confirmed
        Order -> Inventory: Deduct stock
        Order --> Web: Order success
        Web --> Customer: Order confirmation
    else Payment failed
        Payment --> Order: Payment failed
        Order --> Web: Order failed
        Web --> Customer: Payment error
    end
    
else Out of stock
    Inventory --> Order: Out of stock
    Order --> Web: Item unavailable
    Web --> Customer: Out of stock notice
end

@enduml`,

            class: `@startuml
!theme plain
title E-commerce System Class Diagram

class User {
    -userId: String
    -username: String
    -email: String
    -password: String
    +login(): boolean
    +logout(): void
    +updateProfile(): void
}

class Product {
    -productId: String
    -name: String
    -price: BigDecimal
    -stock: int
    -description: String
    +updateStock(quantity: int): void
    +getPrice(): BigDecimal
}

class Order {
    -orderId: String
    -orderDate: Date
    -status: OrderStatus
    -totalAmount: BigDecimal
    +addItem(product: Product, quantity: int): void
    +calculateTotal(): BigDecimal
    +updateStatus(status: OrderStatus): void
}

class OrderItem {
    -quantity: int
    -unitPrice: BigDecimal
    +getSubtotal(): BigDecimal
}

enum OrderStatus {
    PENDING
    CONFIRMED
    SHIPPED
    DELIVERED
    CANCELLED
}

User ||--o{ Order : places
Order ||--o{ OrderItem : contains
OrderItem }o--|| Product : references
Order ||--|| OrderStatus : has

@enduml`,

            usecase: `@startuml
!theme plain
title Online Learning System Use Cases

left to right direction

actor Student as Student
actor Teacher as Teacher
actor Admin as Admin

rectangle "Online Learning System" {
    
    rectangle "Student Features" {
        Student -- (Register Account)
        Student -- (Browse Courses)
        Student -- (Purchase Course)
        Student -- (Watch Videos)
        Student -- (Download Materials)
        Student -- (Join Discussions)
        Student -- (Submit Assignment)
    }
    
    rectangle "Teacher Features" {
        Teacher -- (Upload Course)
        Teacher -- (Edit Course Content)
        Teacher -- (Grade Assignments)
        Teacher -- (Reply to Discussions)
        Teacher -- (View Learning Statistics)
    }
    
    rectangle "Admin Features" {
        Admin -- (Manage Users)
        Admin -- (Review Courses)
        Admin -- (System Settings)
        Admin -- (Generate Reports)
    }
    
    (Purchase Course) ..> (Register Account) : <<include>>
    (Watch Videos) ..> (Purchase Course) : <<include>>
    (Submit Assignment) ..> (Watch Videos) : <<extend>>
}

@enduml`,

            activity: `@startuml
!theme plain
title Customer Support Ticket Handling Process

start

:Receive customer ticket;
:Auto-categorize ticket;

if (Urgent ticket?) then (Yes)
    :Immediately notify on-call staff;
else (No)
endif

:Assign to appropriate support staff;
:Support staff starts handling;

repeat
    :Analyze issue;
    :Provide solution;
    :Communicate with customer;
    
    if (Issue resolved?) then (Yes)
        :Mark ticket as resolved;
        break
    else (No)
        if (Need escalation?) then (Yes)
            :Escalate to senior support;
        else (No)
        endif
    endif
repeat while (Continue handling?)

:Customer confirms satisfaction;

if (Customer satisfied?) then (Yes)
    :Close ticket;
else (No)
    :Reopen ticket;
    backward :Support staff starts handling;
endif

:Record resolution;
:Update knowledge base;

stop

@enduml`
        };

        function switchMode(mode) {
            currentMode = mode;
            
            // Update tab status
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.mode-tab[onclick="switchMode('${mode}')"]`).classList.add('active');
            
            // Update content display
            document.querySelectorAll('.mode-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${mode}-mode`).classList.add('active');
        }

        async function generateDiagram() {
            const input = document.getElementById('plantUmlInput').value.trim();
            const loading = document.getElementById('loading');
            const preview = document.getElementById('diagramPreview');
            const errorMessage = document.getElementById('errorMessage');
            const placeholder = document.getElementById('placeholderText');
            const format = document.querySelector('input[name="format"]:checked').value;

            if (!input) {
                showError('Please enter PlantUML code');
                return;
            }

            // Show loading state
            loading.style.display = 'block';
            preview.style.display = 'none';
            errorMessage.style.display = 'none';
            placeholder.style.display = 'none';

            try {
                if (currentMode === 'cloud') {
                    await generateWithCloud(input, format);
                } else {
                    await generateWithLocal(input, format);
                }
            } catch (error) {
                loading.style.display = 'none';
                showError('Generation failed: ' + error.message);
            }
        }

        async function generateWithCloud(input, format) {
            const encodedCode = plantumlEncoder.encode(input);
            const imageUrl = `https://www.plantuml.com/plantuml/${format}/${encodedCode}`;
            
            const testImage = new Image();
            testImage.onload = function() {
                const loading = document.getElementById('loading');
                const preview = document.getElementById('diagramPreview');
                
                preview.src = imageUrl;
                preview.style.display = 'block';
                loading.style.display = 'none';
                
                // Convert image to blob for download
                fetch(imageUrl)
                    .then(response => response.blob())
                    .then(blob => {
                        currentImageBlob = blob;
                    });
            };
            
            testImage.onerror = function() {
                document.getElementById('loading').style.display = 'none';
                showError('Cloud service could not generate the diagram. Please check syntax or network connection.');
            };
            
            testImage.src = imageUrl;
        }

        async function generateWithLocal(input, format) {
            const serverUrl = document.getElementById('serverUrl').value;
            
            if (!serverUrl) {
                throw new Error('Please set the backend server URL');
            }
            
            const response = await fetch(serverUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    code: input, 
                    format: format 
                })
            });
            
            if (!response.ok) {
                let errorMsg = 'Server error';
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.error || errorMsg;
                } catch (e) {
                    errorMsg = `HTTP ${response.status}: ${response.statusText}`;
                }
                throw new Error(errorMsg);
            }
            
            const imageBlob = await response.blob();
            currentImageBlob = imageBlob;
            
            const imageUrl = URL.createObjectURL(imageBlob);
            const loading = document.getElementById('loading');
            const preview = document.getElementById('diagramPreview');
            
            preview.src = imageUrl;
            preview.style.display = 'block';
            loading.style.display = 'none';
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function clearInput() {
            document.getElementById('plantUmlInput').value = '';
            document.getElementById('diagramPreview').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('placeholderText').style.display = 'block';
            currentImageBlob = null;
        }

        function downloadDiagram() {
            if (!currentImageBlob) {
                showError('Please generate a diagram first');
                return;
            }
            
            const format = document.querySelector('input[name="format"]:checked').value;
            const url = URL.createObjectURL(currentImageBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `plantuml-diagram.${format}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function loadExample(type) {
            document.getElementById('plantUmlInput').value = examples[type];
            generateDiagram();
        }

        // Auto-load initial chart
        window.onload = function() {
            generateDiagram();
        };

        // Shortcut key support 
        document.getElementById('plantUmlInput').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                generateDiagram();
            }
        });
    </script>
</body>
</html>
